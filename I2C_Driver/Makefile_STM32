# Makefile for STM32F401RE Bare Metal I2C Slave

# Toolchain
CC = arm-none-eabi-gcc
OBJCOPY = arm-none-eabi-objcopy
SIZE = arm-none-eabi-size

# Target
TARGET = stm32_i2c_slave

# Source files
SRCS = stm32_i2c_slave.c startup_stm32f401re.c

# Object files
OBJS = $(SRCS:.c=.o)

# Linker script
LDSCRIPT = stm32f401re.ld

# Compiler flags
CFLAGS = -mcpu=cortex-m4
CFLAGS += -mthumb
CFLAGS += -mfloat-abi=hard
CFLAGS += -mfpu=fpv4-sp-d16
CFLAGS += -O2
CFLAGS += -Wall
CFLAGS += -ffunction-sections
CFLAGS += -fdata-sections
CFLAGS += -DSTM32F401xE

# Linker flags
LDFLAGS = -mcpu=cortex-m4
LDFLAGS += -mthumb
LDFLAGS += -mfloat-abi=hard
LDFLAGS += -mfpu=fpv4-sp-d16
LDFLAGS += -specs=nosys.specs
LDFLAGS += -T$(LDSCRIPT)
LDFLAGS += -Wl,--gc-sections
LDFLAGS += -Wl,-Map=$(TARGET).map

# Default target
all: $(TARGET).bin $(TARGET).hex
	@echo "Build complete!"
	@$(SIZE) $(TARGET).elf

# Compile
%.o: %.c
	@echo "Compiling $<..."
	@$(CC) $(CFLAGS) -c $< -o $@

# Link
$(TARGET).elf: $(OBJS)
	@echo "Linking..."
	@$(CC) $(OBJS) $(LDFLAGS) -o $@

# Create binary
$(TARGET).bin: $(TARGET).elf
	@echo "Creating binary..."
	@$(OBJCOPY) -O binary $< $@

# Create hex
$(TARGET).hex: $(TARGET).elf
	@echo "Creating hex..."
	@$(OBJCOPY) -O ihex $< $@

# Flash using st-link
flash: $(TARGET).bin
	st-flash write $(TARGET).bin 0x8000000

# Flash using openocd (alternative)
flash-openocd: $(TARGET).bin
	openocd -f interface/stlink.cfg -f target/stm32f4x.cfg \
		-c "program $(TARGET).bin 0x08000000 verify reset exit"

# Clean
clean:
	@echo "Cleaning..."
	@rm -f $(OBJS) $(TARGET).elf $(TARGET).bin $(TARGET).hex $(TARGET).map

# Phony targets
.PHONY: all clean flash flash-openocd

# Help
help:
	@echo "STM32F401RE I2C Slave Makefile"
	@echo ""
	@echo "Targets:"
	@echo "  all            - Build the project"
	@echo "  clean          - Remove build files"
	@echo "  flash          - Flash using st-flash"
	@echo "  flash-openocd  - Flash using OpenOCD"
	@echo "  help           - Show this help"
	@echo ""
	@echo "Requirements:"
	@echo "  - arm-none-eabi-gcc toolchain"
	@echo "  - st-flash or OpenOCD for flashing"
